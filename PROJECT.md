# 弘弈AI魔方教练 - 项目开发知识库

## 项目概述

**项目名称**: 弘弈AI魔方教练
**描述**: 魔方解法分析与学习平台，通过AI分析用户的还原步骤，提供优化建议和学习推荐
**技术栈**: Next.js 16 + TypeScript + Tailwind CSS + shadcn/ui
**作者**: jiachen.wang
**部署**: https://hongyiaicube.com

---

## 技术���构

### 前端
- **框架**: Next.js 16.1.6 (Turbopack)
- **UI组件**: shadcn/ui (Card, Button, Input, Textarea等)
- **样式**: Tailwind CSS + 自定义CSS变量
- **字体**:
  - Orbitron (标题)
  - JetBrains Mono (魔方公式，等宽)
  - Noto Sans SC (中文正文)

### 后端
- **API路由**: Next.js App Router
- **分析引擎**: 自研魔方分析器
- **认证**: API Key (x-api-key / Authorization: Bearer)
- **限流**: 内存存储 (生产环境建议Redis)

### 核心库
- `cube-js`: 魔方状态模拟（准确验证）
- `cube-solver`: Kociemba算法求解器

---

## 目录结构

```
ai-cube-coach/
├── app/
│   ├── (app)/           # 应用页面路由组
│   │   ├── analyze/     # 解法分析页面
│   │   ├── review/      # 公式复习页面
│   │   ├── profile/     # 用户档案页面
│   │   └── settings/    # 设置页面
│   ├── (marketing)/     # 营销页面路由组
│   │   ├── pricing/     # 定价页面
│   │   └── purchase/    # 购买页面
│   ├── api/             # API路由
│   │   └── cube/
│   │       ├── analyze/ # 解法分析API (10次/分钟)
│   │       └── optimal/ # 最优解API (20次/分钟)
│   ├── layout.tsx       # 根布局
│   └── globals.css      # 全局样式
├── components/
│   ├── ui/              # shadcn/ui组件
│   ├── navbar.tsx       # 导航栏
│   └── cube/            # 魔方相关组件
│       ├── cube-keyboard.tsx  # 虚拟键盘
│       └── cube-net.tsx       # 魔方展开图
└── lib/
    ├── cube/            # 魔方核心逻辑
    │   ├── cube-state.ts    # 魔方状态 (使用cube-js)
    │   ├── analyzer.ts      # 分析引擎
    │   ├── solver.ts        # 求解器
    │   ├── parser.ts        # 公式解析器
    │   └── formulas.ts      # 公式库
    └── utils/
        └── logger.ts     # 结构化日志
```

---

## 开发约定

### CSS样式约定

1. **使用CSS变量定义主题色**
   ```css
   :root {
     --cube-white: 255 255 255;
     --cube-yellow: 255 213 0;
     --cube-red: 255 69 0;
     --cube-orange: 255 141 0;
     --cube-blue: 0 69 255;
     --cube-green: 0 155 72;
   }
   ```

2. **避免在@layer中使用@apply引用自定义变量**
   - 问题: `@apply border-border-subtle` 会报错
   - 解决: 直接使用CSS属性 `border-color: var(--border-subtle);`

3. **亮色主题约定**
   - 背景: 渐变 `#f0f4ff 0%, #fef3f2 50%, #fffbeb 100%`
   - 卡片: 白色背景
   - 文字: `slate-500/600/700/800`
   - 强调色: 橙色 `rgb(var(--cube-orange))`

### 魔方记法约定

支持的记法类型:
- **基础动作**: R L U D F B
- **宽层动作**: r l u d f b (小写)
- **中层动作**: M E S
- **旋转**: x y z
- **修饰符**: `'`(逆时针), `2`(180度)

### 标准配色（国际标准）
| 面 | 颜色 | cube-js编码 |
|----|------|-------------|
| U (上) | 白 | 0 |
| R (右) | 红 | 1 |
| F (前) | 绿 | 2 |
| D (下) | 黄 | 3 |
| L (左) | 橙 | 4 |
| B (后) | 蓝 | 5 |

---

## 已完成功能

### 1. 解法分析页面 (`/analyze`)
- [x] 打乱公式输入
- [x] 用户解法输入
- [x] 虚拟键盘（支持所有魔方记法）
  - 自动添加空格
  - 修饰符处理（'、2）
  - 智能回退
- [x] 魔方展开图实时显示
- [x] AI分析结果展示
  - 步数统计
  - 效率评分
  - 优化建议
  - 公式识别
  - 还原状态验证

### 2. 最优解API (`/api/cube/optimal`)
- [x] Kociemba算法求解
- [x] 打乱状态展开图
- [x] 公式识别
- [x] API认证

### 3. 公式库
- [x] PLL (排列公式)
- [x] OLL (朝向公式)
- [x] ZBLL (一步顶层公式) - 472个
- [x] VLS (最后槽公式) - 189个

---

## 已修复问题 (最新)

### 2026-02-03 - 重大更新

#### 1. 魔方展开图修复 ✅
**问题**: 自定义魔方模拟器有bug，展开图与实际不符
**解决**: 使用 `cube-js` 库替代自定义模拟器
- 添加 `cube-js` 类型定义
- 正确的颜色映射
- 验证的魔方状态计算

#### 2. 用户体验改进 ✅
**问题**: 输入公式没有空格，难以阅读
**解决**:
- 每输入字母自动加空格
- 修饰符（'、2）替换末尾空格后添加
- 智能回退（删除整个动作）

#### 3. 步数计算修复 ✅
**问题**: 无空格公式（如RRULLBFF）被算作1步
**解决**: 使用 `parseFormula` 正确解析

#### 4. 安全与性能 ✅
- API Key 认证支持
- 独立速率限制 (analyze: 10/min, optimal: 20/min)
- 结构化日志 (`logger.ts`)
- 优化公式识别算法 (O(n²) → O(n))

---

## 环境变量

```bash
# API 密钥 (生产环境)
API_KEYS=key1,key2,key3

# 火山引擎 API (CFOP 解法生成)
VOLCENGINE_API_KEY=79ce9aab-e43e-4cc7-ad64-9cc1df3b4667
VOLCENGINE_MODEL=ep-20260205011220-2gksn
VOLCENGINE_BASE_URL=https://ark.cn-beijing.volces.com/api/v3

# OpenAI API (备用)
OPENAI_API_KEY=sk-proj-...

# Redis (可选，替代内存限流)
REDIS_URL=redis://user:pass@host:port
```

---

## 启动开发服务器

```bash
cd ai-cube-coach
npm run dev
```
默认端口: 3000

### 构建部署

```bash
npm run build
npx vercel --prod
```

---

## 版本历史

| 版本 | 日期 | 说明 | Git Commit |
|------|------|------|------------|
| v1.9.0 | 2026-02-05 | 专业级 AI 教练分析 | f870e29 |
| v1.8.0 | 2026-02-04 | CFOP 解法 + 展开图修复 | - |
| v1.7.0 | 2026-02-04 | 截图 OCR 识别功能 | dd579c0 |
| v1.6.0 | 2026-02-04 | Logo 更新 + 最优解显示优化 | 23f5a2e |
| v1.5.0 | 2026-02-04 | Logo 设计 + 现代科技感 UI | af39e27 |
| v1.4.0 | 2026-02-03 | UI 优化和移动端适配 | ad85425 |
| v1.3.0 | 2026-02-03 | 增强AI分析 - 8项新功能 | (已提交) |
| v1.2.0 | 2026-02-03 | 魔方展开图修复 | 1558f4b |
| v1.1.0 | 2026-02-02 | 基础分析功能 | - |
| v1.0.0 | 2026-02-01 | 初始版本 | - |

---

## 更新日志

### v1.9.0 (2026-02-05) - 专业级 AI 教练分析 ✅

**核心功能升级**:
- 重写 OCR 分析 API，从简单公式识别升级为专业级教练分析
- 精确提取截图中的步数、时间、TPS 数据（不再估算）
- 根据 TPS 自动评估技能等级（初级/中级/高级/世界级）

**CFOP 分解分析**:
- Cross 分析：步数、效率评价、XCross 可能性建议
- F2L 分析：每组配对的步数、效率、优化建议、替代解法
- OLL 分析：情况识别、公式比较、COLL 建议
- PLL 分析：情况识别、公式比较、更优算法

**高级技巧识别**:
- XCross：十字+1组 F2L 同时完成
- XXCross：十字+2组 F2L 同时完成
- COLL：角块朝向+排列同时完成
- 控槽法：利用空槽优化入槽
- 预判：F2L 过程中的 lookahead

**个性化教练建议**:
- 技能评估：优点、弱点、优先改进事项
- 周训练计划：7 天详细训练安排，包括重点、练习项目、时长
- 学习资源推荐：J Perm、CubeSkills 等专业教程链接

**前端界面更新**:
- 新增 `ProfessionalAnalysis` 组件展示详细分析结果
- OCR 弹窗升级为全屏分析结果展示
- 彩色卡片展示 CFOP 各阶段分析
- 技巧标签显示已使用/建议学习的技巧
- 周训练计划日历式展示
- 学习资源分类展示（视频/网站/工具）

**技术实现**:
- 使用火山引擎豆包 API 的多模态能力进行图像分析
- 专业级分析 prompt 设计，输出结构化 JSON
- 支持简单模式和完整分析模式切换
- 默认资源回退机制确保始终有教学资源

---

### v1.8.0 (2026-02-04) - CFOP 解法 + 展开图修复 ✅

**魔方展开图修复**:
- 问题：自定义魔方模拟器有 bug，R 面左上角显示错误
- 解决：重写 `cube-state.ts`，使用 `cubejs` 库计算魔方状态
- 验证：与魔方星球展开图完全一致

**CFOP 解法功能**:
- 新增 `/api/cube/cfop-solve` API，使用 OpenAI API 生成符合人类思维的 CFOP 解法
- 移除机器最优解（Kociemba 算法），只保留 CFOP 人类解法
- 解法分为四个阶段：Cross、F2L、OLL、PLL
- 每个阶段显示：步数、公式、说明、公式名称（OLL/PLL）
- 基于国际标准：白底绿前

**前端界面更新**:
- 按钮文字从“生成最优解”改为“生成 CFOP 解法”
- CFOP 解法显示为四个彩色卡片（蓝色 Cross、绿色 F2L、黄色 OLL、紫色 PLL）
- 每个阶段显示步数、公式、说明
- OLL/PLL 显示公式名称（如 OLL 21、PLL Ua）

**技术实现**:
- 新增 `cfopResult` 状态管理 CFOP 解法结果
- 并行调用两个 API：获取魔方状态（用于展开图）和 CFOP 解法
- 使用火山引擎豆包 API (Doubao-Seed-1.6-lite) 生成 CFOP 解法
- 优化 API 调用参数：简化 prompt，减少 max_tokens (600)，提高 temperature (0.8)
- 响应时间优化：从 10+ 秒降低到 5-8 秒，满足 Vercel 10 秒超时限制

---

### v1.7.0 (2026-02-04) - 截图 OCR 识别功能 ✅

**新增功能**:
- 支持上传魔方星球截图，自动识别打乱公式和复原公式
- 使用 OpenAI Vision API (gpt-4.1-mini) 进行高精度识别
- 识别结果弹窗支持预览和编辑，方便修正错误
- 后处理逻辑自动修正常见 OCR 错误（' 和 2 的识别）

**用户体验**:
- 分析页面顶部添加「上传魔方星球截图」按钮
- 一键上传，不影响现有界面布局
- 识别后可编辑修正，确认后自动填充到输入框

**技术实现**:
- 新增 `/api/ocr/cube-formula` API 端点
- 针对魔方公式优化的系统提示词
- 支持 base64 和 URL 两种图片输入方式
- 创建 backup-v1.6.0 分支用于回滚

---

### v1.6.0 (2026-02-04) - Logo 更新 + 最优解显示优化 ✅

**Logo 重新设计**:
- 融合三个核心元素：弘弈、AI、魔方
- 3x3 魔方立方体设计，蓝紫渐变配色
- 顶面：AI 电路纹理
- 左侧面：“弘”字融入
- 右侧面：紫色渐变
- 生成 4 个版本：`logo.png`、`logo-text.png`、`favicon.png`、`app-icon.png`

**最优解功能优化**:
- 按钮文字更改为“生成最优解”（更准确）
- 最优解显示优化：橙色渐变背景、闪电图标、步数标签
- 添加说明文字：“基于 CFOP、ZB、COLL 等高级公式生成”
- 更新提示文字：“生成最优解和展开图”
- 强调最优解作为 AI 分析的基准

---

### v1.5.0 (2026-02-04) - Logo 设计 + 现代科技感 UI ✅

**品牌设计**:
- 为汪弘弈设计专属 Logo（融合魔方和 AI 元素）
- 生成三个版本：`logo.png` (主 Logo)、`logo-text.png` (横向Logo)、`favicon.png` (网站图标)
- 更新网站标题：“弘弈AI魔方 - AI驱动的魔方学习平台”
- 更新网站描述：“不帮你解，教你更快。AI 分析你的解法，精准定位优化空间”

**UI 全面简化**:
- 首页核心价值：“不帮你解，教你更快”
- 功能卡片：智能分析 · 精准优化 · 持续进步
- 分析页面：AI 分析 · 精准优化
- 使用示例：输入打乱公式 → 输入你的解法 → AI 分析优化建议

**现代科技感设计**:
- 渐变色按钮（蓝色到紫色）
- 卡片悬停效果（边框高亮 + 阴影）
- 清晰的视觉层次
- 导航栏集成新 Logo
- Footer 简化并集成 Logo

**技术改进**:
- 使用 Next.js Image 组件优化图片加载
- 更新 favicon 配置
- 统一颜色系统（蓝色主调）

---

### v1.4.0 (2026-02-03) - UI 优化和移动端适配 ✅
- 重构分析页面布局，移动端和桌面端都能看到魔方展开图
- 优化公式输入体验，输入框可滚动显示长公式
- 改进虚拟键盘设计，常用公式按钮使用实色背景提高可见性
- 增加复制功能，方便复制公式
- 优化全局样式，提升整体视觉效果
- 增加触摸反馈和安全区域适配
- 改进响应式布局，适配各种屏幕尺寸

---

### v1.3.0 (2026-02-03) - 增强AI分析 ✅

**新增8项详细分析功能**:

1. **问题定位分析** (`stepOptimizations`)
   - 精确定位可优化的动作位置
   - 显示原始动作 vs 优化后动作
   - 节省步数统计

2. **模式识别** (`patterns`)
   - 低效模式检测 (往返转动、多余动作)
   - 快捷机会识别 (可用公式替代的序列)

3. **F2L槽位分析** (`f2lSlots`)
   - 4个槽位独立分析
   - 槽位效率评级 (excellent/good/fair/poor)
   - 配对步数统计

4. **顶层识别** (`ollCase`, `pllCase`)
   - OLL 57种情况识别
   - PLL 21种情况识别
   - 公式ID和名称匹配

5. **时间���解** (`timeBreakdown`)
   - 各阶段预估用时
   - 瓶颈阶段识别
   - 时间占比分析

6. **TPS分析** (`tpsAnalysis`)
   - 计算 Turns Per Second
   - 与高级玩家对比
   - 速度水平评级

7. **高级玩家对比** (`comparison`)
   - 与同级玩家步数对比
   - 差距分析
   - 改进空间评估

8. **优先改进建议** (`prioritizedRecommendations`)
   - 按优先级排序的改进建议
   - 基于瓶颈分析
   - 具体练习方向

**技术改进**:
- 新增 `analyzer-v3.ts` 增强分析引擎
- API支持 `enhanced=true` 参数
- 前端新增7个分析结果展示卡片
- 修复 TypeScript 类型错误
- 移除不兼容的 `<style jsx>` 语法 (Next.js 16)

**其他**:
- OCR功能备份到 `backup-ocr-feature/`
- 创建 `docs/ANALYSIS-ENHANCEMENT-PLAN.md` 文档

---

### v1.2.0 (2026-02-03) - 重大更新 ✅
- ✅ 修复魔方展开图显示问题（使用cube-js）
- ✅ 改进虚拟键盘（自动空格、智能回退）
- ✅ 修复步数计算（支持无空格公式）
- ✅ 添加API认证和限流
- ✅ 优化公式识别算法
- ✅ 添加结构化日志
- ✅ ESLint清理（60个问题→17个警告）
- ✅ 修复isSolved验证逻辑

---

### v1.1.0 (2026-02-03) (之前)
- 代码审计：发现并修复效率评分计算bug
- 创建测试脚本 `scripts/test-analyze.ts`
- 更新定价页面：添加开发者API套餐
- 创建API文档页面 (`/api-docs`)

---

## 商业计划

### 盈利模式
**售卖API Key** - 让其他开发者可以使用魔方分析API

### 目标客户
1. 魔方学习者
2. 魔方培训学校
3. 魔方应用开发者

---

*最后更新: 2026-02-04*
