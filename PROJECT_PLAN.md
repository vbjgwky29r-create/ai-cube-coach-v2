# AI Cube Coach - Merged Project Plan

Last Updated: 2026-02-18
Status: Active

## 0. 不变的产品目标（固定）
- 项目定位不变：AI 魔方教练。
- 核心价值不变：
  1. 求解器给出真实 CFOP 解法（不是逆打乱）。
  2. 与人类解法对比。
  3. 生成可执行的训练建议。

## 1. 固定约束（必须遵守）
- 求解必须严格按 `Cross -> F2L -> OLL -> PLL`。
- 禁止把 inverse scramble 作为用户解法输出。
- Cross 是 F2L 的前置基础：Cross 不通过，不进入 F2L。
- 每次验证必须输出：
  - `Scramble`
  - `Solution`
  - 分阶段验证结果（Cross/F2L/Final solved）
- 优先使用仓库 verified 样例验证；新增样例使用 WCA 20 步打乱。

## 2. 合并后的执行策略（研究型迭代）

### 2.1 基线与回归（先做）
- 建立固定回归集：`VERIFIED_TEST_CASES.md` + `VERIFIED_SCRAMBLES.md`。
- 建立统一验证脚本：自动回放并给出阶段通过率。
- 验收口径统一为“可回放 + 可复原 + 可解释”。

### 2.2 求解器主链重构（中期重点）
- 统一单一主链入口：`Cross -> F2L -> OLL -> PLL`。
- 旧实验求解器（legacy）仅保留作对照，不作为默认结果来源。
- 所有阶段输出统一数据结构（moves / steps / case / verified）。

### 2.3 F2L 专项攻坚（核心难点）
- 采用“分层法 + permutation/cp-ep/co-eo + 查表(PDB)”混合策略。
- 每个槽位输出：识别状态、选用case、求解结果。
- 目标：从“部分槽位成功”提升到“4槽稳定完成”。

### 2.4 OLL/PLL 稳定化（并行）
- 保留并增强已有识别器能力。
- 输出可教学标签（case id/case name/替代公式）。

### 2.5 教练对比引擎（在求解稳定后）
- 人类解 vs 求解器解：
  - 总步数差
  - 分阶段步数差
  - 冗余操作识别
  - 推荐替换公式

## 3. MVP（需求不变）
- 输入打乱公式后，返回真实 CFOP 四阶段解法。
- 返回每阶段步数与总步数。
- 返回阶段验证结果（Cross/F2L/最终复原）。
- 支持基础公式输入与可视化反馈。
- 禁止逆打乱作为结果输出。

## 4. 后续更新计划（需求不变）
- 在 MVP 稳定后逐步增强：
  1. 提升 F2L 覆盖率与稳定性（混合求解器 + PDB）。
  2. 提高“最快可解释 CFOP”质量。
  3. 完善教练型建议输出（面向训练改进）。

### 4.1 内测后商用 API 扩展计划（高并发）
- 目标：从“单实例可用”升级为“可承载商业 API 并发”的稳定架构。
- 分阶段路线：
  1. API 网关层：
     - API Key 鉴权、按套餐配额、QPS/并发限流。
     - 限流和配额存储迁移到 Redis（替代进程内 Map）。
  2. 计算异步化：
     - 提供 `submit job` + `query job` 模式，重计算请求入队。
     - Worker 集群消费队列，支持失败重试和超时控制。
  3. 分层缓存：
     - L1 进程内短缓存 + L2 Redis 结果缓存。
     - 按 `scramble + mode + solverVersion` 做缓存键，支持热点预热。
  4. 稳定性治理：
     - 统一超时、重试、熔断、降级策略。
     - 建立 P50/P95 延迟、失败率、队列积压、单 key 成本监控。
  5. 商业化接口能力：
     - 套餐分层（fast/full）、配额透传、账单统计与审计日志。

## 5. 最终版（需求不变）
- 求解器包含高级公式体系：`COLL / ZB / ZBLL`（含 case 识别与教学输出）。
- 商业化能力完整：
  - 付费
  - 订阅
  - API Key 订阅形态
- 免费/付费仅做能力分层，不影响基础求解正确性。

## 6. 当前优先级（Now)
1. Cross/F2L 正确率与稳定性
2. 分阶段验证闭环
3. 教练对比输出
4. 付费与订阅系统

## 7. 近期验收标准
- 可在 verified 样例上稳定给出 `Scramble + Solution` 并回放复原。
- Cross 通过后再进入 F2L，且状态检查可追踪。
- API 返回中包含分阶段验证字段。

## 8. 阶段记录（2026-02-16）
### 已完成
1. F2L 选槽策略升级为“先评估再决策”：
- 每轮先评估各未完成槽位的“转标态成本”。
- 评分维度：状态层级、步数、转体成本、B 面成本。
2. F2L 正确性修复：
- 修复“输出槽位公式但槽位未完成”的问题（未完成自动回滚）。
- 保证槽位求解不破坏 Cross 与已锁定槽位。
3. OLL 兜底增强：
- 新增宏动作 BFS 兜底（保前两层不破坏）。
4. 可观测性增强：
- 增加 `slotHistory`（时序槽位公式）。
- 增加 `roundScores`（每轮槽位评分明细）。

### 验证结果（WCA 两条）
1. `F' U2 R' F B2 U F R' B2 R2 F2 B2 R' F2 L D2 R' U2 B`
- Verified: `true`
- Total: `51`
2. `B' R D F2 U' R' D B' D' U2 B2 U2 L U2 L' D2 L2 B2 U2 L'`
- Verified: `true`
- Total: `59`

### 当前风险
- 局部样例中仍可能出现“人类可执行性不佳（虽可还原但不够顺手）”的 F2L 序列。
- 评分权重仍需继续调优（当前偏正确率，步数仍有下降空间）。

### 下一阶段
1. 扩展 10-20 条 WCA 批量验证，统计通过率与步数分布。
2. 用黄金样例继续调权重，优先优化“标态->入槽”的人类可执行性。
3. 强化 BR/BL 的短公式优先级，减少复杂兜底插入。
